# 优化版交互式光线追踪器

## 项目概述

这是一个高度优化的交互式光线追踪应用程序，实现了基于物理的渲染效果，同时保持流畅的用户交互体验。该程序使用Windows GDI作为图形输出后端，无需额外的图形库依赖即可运行。

## 主要特性

### 渲染功能
- 基于物理的光照模型，支持环境光、漫反射、镜面反射
- 实时光线阴影计算
- 反射效果（带材质颜色影响）
- 场景包含球体和平面几何
- 增量渲染技术，提高初始渲染速度
- 色调映射和伽马校正，改善视觉效果

### 性能优化
- **交互模式检测**：自动识别用户交互状态，动态调整渲染质量
- **优先检测算法**：交互时优先检测选中物体，减少不必要计算
- **智能渲染简化**：
  - 交互模式下仅使用一个主要光源
  - 70%概率跳过阴影计算
  - 完全跳过反射计算
- **相机向量缓存**：避免重复计算相机变换矩阵
- **批量扫描线渲染**：每帧渲染60行，平衡渲染速度和视觉连贯性

### 用户交互
- 鼠标左键拖动：选择并移动球体
- 鼠标滚轮：缩放选中球体（半径限制：0.2-3.0）
- 方向键：旋转相机视角（带角度限制）
- 数字键1-9：更改选中球体颜色
- R/r键：增加反射率
- T/t键：减少反射率

## 系统要求

- Windows操作系统
- C++编译器（支持C++11或更高版本）
- Windows SDK（提供GDI支持）

## 编译和运行

### 使用g++编译

```bash
cd bin
g++ OptimizedInteractiveApp.cpp -o HW4.exe -lgdi32 -O2
```

### 直接运行

编译完成后，可以直接运行生成的可执行文件：

```bash
.\HW4.exe
```

## 文件结构

```
d:\coding\CG\CGHW4\
├── bin\                  # 编译输出目录
│   ├── OptimizedInteractiveApp.cpp  # 优化后的主源代码
│   ├── HW4.exe  # 编译后的可执行文件
│   ├── opencv_world4120.dll         # OpenCV运行库（备用）
│   └── opencv_world4120d.dll        # OpenCV调试库（备用）
├── include\              # 第三方头文件库
├── lib\                  # 第三方链接库
├── HW4\                  # 原始项目文件
└── 作业4 光线跟踪算法.pdf   # 项目说明文档
```

## 性能优化详解

### 1. 交互模式智能切换

程序通过`isInteractiveMode`标志自动识别用户交互状态，在用户拖动鼠标时切换到高性能模式，释放鼠标后恢复高质量渲染。

### 2. 场景相交检测优化

- 优先检测用户选中的物体
- 使用索引迭代而非范围for循环，避免重复计算
- 实现早期退出机制，减少不必要的光线-物体相交测试

### 3. 光照模型简化

在交互模式下，程序自动采用以下简化策略：

- 仅计算第一个光源的贡献
- 70%概率跳过阴影计算
- 完全跳过反射计算
- 简化镜面反射计算

### 4. 相机向量缓存

实现了相机变换向量的缓存机制，避免每生成一条光线就重复计算相机坐标系。

### 5. 增量渲染改进

- 每帧渲染60行扫描线（原为30行）
- 交互结束后自动触发全渲染
- 维护帧缓冲区，减少重复计算

## 渲染效果说明

程序创建的场景包含：
- 两个平面（地面和背景）
- 三个可交互球体
- 两个光源

渲染过程中应用了环境光遮蔽、物理衰减模型和微表面镜面反射，产生更真实的视觉效果。

## 注意事项

- 程序使用Windows GDI直接绘图，在高分辨率显示器上可能帧率较低
- 首次运行时会显示增量渲染过程，随后每秒钟刷新一次完整画面
- 为获得最佳性能，请确保在编译时启用优化选项（-O2）

## 许可证

本项目仅供学习和研究使用。
